---
import { promises as fs } from "node:fs";
import path from "node:path";
import BaseLayout from "../../../../layouts/BaseLayout.astro";
import {
  getFeatureKindsLinkedToRequirements,
  getPoliciesDetailed,
  getSpecifications,
  getUiPageById,
  getUiPages,
} from "../../../../lib/spec-data";

export async function getStaticPaths() {
  const pages = await getUiPages();
  return pages.map((page) => ({ params: { id: page.id } }));
}

const pageId = String(Astro.params.id ?? "");
const detail = await getUiPageById(pageId);
if (!detail) {
  throw new Error(`Unknown UI page: ${pageId}`);
}

const screenshotFile = `${detail.id}.png`;
const screenshotPath = path.resolve(process.cwd(), `public/screenshots/${screenshotFile}`);
const hasScreenshot = await fs.access(screenshotPath).then(() => true).catch(() => false);

const specs = await getSpecifications();
const exactSpec = specs.find((item) => item.sourceFile === `ui/pages/${detail.fileName}`);
const fallbackUiSpec = specs.find((item) => item.sourceFile.startsWith("ui/pages/"));
const mappedSpec = exactSpec ?? fallbackUiSpec;

const linkedRequirementIds = mappedSpec?.linkedRequirements ?? [];
const linkedFeatureKinds = await getFeatureKindsLinkedToRequirements(linkedRequirementIds);

const policies = await getPoliciesDetailed();
const linkedPolicies = policies.filter((policy) =>
  (mappedSpec?.linkedPolicies ?? []).includes(policy.id),
);

const components = (detail.raw.components ?? {}) as Record<string, unknown>;
const sharedComponents = Array.isArray(components.shared) ? components.shared : [];
const bodyComponents = Array.isArray(components.body) ? components.body : [];

function componentSummary(component: unknown): { id: string; type: string } {
  if (!component || typeof component !== "object") {
    return { id: "component", type: "unknown" };
  }

  const item = component as { id?: unknown; type?: unknown };
  return {
    id: typeof item.id === "string" && item.id.length > 0 ? item.id : "component",
    type: typeof item.type === "string" && item.type.length > 0 ? item.type : "unknown",
  };
}

const toc = [
  { id: "overview", title: "Overview" },
  { id: "components", title: "Components" },
  { id: "relations", title: "Related Design" },
];
---

<BaseLayout
  title={`${detail.title} | UI Page | Ugoite`}
  description={`UI page specification for ${detail.id}`}
  toc={toc}
  related={[
    { href: "/app/frontend/pages", label: "UI Pages Index" },
    { href: `/docs/spec/ui/pages/${detail.fileName.replace(/\.yaml$/i, "")}`, label: "Source Spec" },
  ]}
>
  <section id="overview" class="doc-card-hero">
    <span class="doc-pill">{detail.id}</span>
    <h1 style="font-size: 2rem; font-weight: 800; margin-top: 0.75rem;">{detail.title}</h1>
    <p style="font-size: 0.8125rem; color: var(--doc-muted); margin-top: 0.5rem;">
      Route: <code>{detail.route}</code> ¬∑ Implementation: <strong>{detail.implementation ?? "unknown"}</strong>
    </p>
    <p style="font-size: 0.75rem; color: var(--doc-muted); margin-top: 0.25rem;">
      Spec: docs/spec/ui/pages/{detail.fileName}
    </p>
  </section>

  <section class="doc-card" style="padding: 0; overflow: hidden;">
    <div style="height: 18rem; background: var(--doc-bg-subtle); display: flex; align-items: center; justify-content: center;">
      {hasScreenshot ? (
        <img src={`/screenshots/${screenshotFile}`} alt={`${detail.title} screenshot`} style="width: 100%; height: 100%; object-fit: cover; object-position: top;" loading="lazy" />
      ) : (
        <div style="text-align: center; color: var(--doc-muted);">
          <div style="font-size: 2rem;">üñ•Ô∏è</div>
          <div style="font-size: 0.75rem; margin-top: 0.25rem;">Screenshot pending (generated by mise run e2e)</div>
        </div>
      )}
    </div>
  </section>

  <section id="components" class="doc-card">
    <h2 style="font-size: 1.125rem; font-weight: 700; margin-bottom: 0.75rem;">Components</h2>
    <div class="doc-grid-3">
      <article class="doc-card" style="padding: 1rem;">
        <h3 style="font-size: 0.875rem; font-weight: 700; margin-bottom: 0.5rem;">Shared</h3>
        <div style="display: grid; gap: 0.5rem;">
          {sharedComponents.length === 0 ? (
            <p style="font-size: 0.75rem; color: var(--doc-muted);">No shared components</p>
          ) : (
            sharedComponents.map((component) => {
              const item = componentSummary(component);
              return (
                <div style="border: var(--doc-border-width) solid var(--doc-border); border-radius: var(--doc-radius-md); padding: 0.5rem;">
                  <p style="font-size: 0.75rem; font-weight: 600;">{item.id}</p>
                  <p style="font-size: 0.6875rem; color: var(--doc-muted);">{item.type}</p>
                </div>
              );
            })
          )}
        </div>
      </article>

      <article class="doc-card" style="padding: 1rem;">
        <h3 style="font-size: 0.875rem; font-weight: 700; margin-bottom: 0.5rem;">Body</h3>
        <div style="display: grid; gap: 0.5rem;">
          {bodyComponents.length === 0 ? (
            <p style="font-size: 0.75rem; color: var(--doc-muted);">No body components</p>
          ) : (
            bodyComponents.map((component) => {
              const item = componentSummary(component);
              return (
                <div style="border: var(--doc-border-width) solid var(--doc-border); border-radius: var(--doc-radius-md); padding: 0.5rem;">
                  <p style="font-size: 0.75rem; font-weight: 600;">{item.id}</p>
                  <p style="font-size: 0.6875rem; color: var(--doc-muted);">{item.type}</p>
                </div>
              );
            })
          )}
        </div>
      </article>
    </div>
  </section>

  <section id="relations" class="doc-card">
    <h2 style="font-size: 1.125rem; font-weight: 700; margin-bottom: 0.75rem;">Related Design</h2>

    <div style="margin-bottom: 0.75rem;">
      <p style="font-size: 0.75rem; font-weight: 600; margin-bottom: 0.25rem;">Policies</p>
      <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
        {linkedPolicies.map((policy) => (
          <a href={`/design/policies/${policy.id.toLowerCase()}`} class="doc-pill doc-pill-outline">{policy.id}</a>
        ))}
      </div>
    </div>

    <div style="margin-bottom: 0.75rem;">
      <p style="font-size: 0.75rem; font-weight: 600; margin-bottom: 0.25rem;">Requirements</p>
      <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
        {linkedRequirementIds.map((requirementId) => (
          <a href={`/design/requirements#${requirementId.toLowerCase()}`} class="doc-pill doc-pill-outline">{requirementId}</a>
        ))}
      </div>
    </div>

    <div>
      <p style="font-size: 0.75rem; font-weight: 600; margin-bottom: 0.25rem;">Features</p>
      <div style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
        {linkedFeatureKinds.map((feature) => (
          <a href={`/app/api-storage/apis/${feature}`} class="doc-pill doc-pill-outline">{feature}</a>
        ))}
      </div>
    </div>
  </section>
</BaseLayout>
