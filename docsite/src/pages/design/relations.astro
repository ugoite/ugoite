---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { withBasePath } from "../../lib/base-path";
import {
  getFeatureGroups,
  getPhilosophies,
  getPoliciesDetailed,
  getRequirementGroups,
  getRequirementToFeatureEdges,
} from "../../lib/spec-data";

const philosophies = await getPhilosophies();
const policies = await getPoliciesDetailed();
const reqGroups = await getRequirementGroups();
const featureGroups = await getFeatureGroups();
const reqToFeature = await getRequirementToFeatureEdges();

const reqToFeatureMap = new Map<string, string[]>();
for (const edge of reqToFeature) {
  const items = reqToFeatureMap.get(edge.requirement) ?? [];
  items.push(edge.feature);
  reqToFeatureMap.set(edge.requirement, items);
}

const toc = [
  { id: "overview", title: "Overview" },
  { id: "full-graph", title: "Full Relationship Graph" },
  { id: "policy-detail", title: "Policy Connections" },
];
---

<BaseLayout
  title="Design Relations | Ugoite"
  description="Interactive relationship diagram between philosophies, policies, requirements, and features."
  toc={toc}
  related={[
    { href: "/design", label: "Design Overview" },
    { href: "/design/philosophy", label: "Philosophy" },
    { href: "/design/policies", label: "Policies" },
    { href: "/design/requirements", label: "Requirements" },
    { href: "/design/features", label: "Features" },
  ]}
>
  <section id="overview" class="doc-card-hero">
    <div style="position: relative; z-index: 1;">
      <span class="doc-pill">Traceability</span>
      <h1 style="font-size: 2rem; font-weight: 800; margin-top: 0.75rem; letter-spacing: -0.02em;">
        Design Relationship Map
      </h1>
      <p style="color: var(--doc-muted); margin-top: 0.5rem; max-width: 44rem; line-height: 1.6;">
        Every design decision in Ugoite is traceable. Philosophies drive policies, policies anchor requirements, and requirements manifest as deliverable features. Click any node to explore its details.
      </p>
    </div>
  </section>

  <!-- Full Relationship Graph -->
  <section id="full-graph" class="doc-card" style="overflow-x: auto;">
    <h2 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 1.5rem;">Full Relationship Graph</h2>

    <div class="doc-relation-graph">
      <!-- Layer 1: Philosophy -->
      <div class="doc-relation-layer">
        <div class="doc-relation-layer-label">Philosophy</div>
        <div class="doc-relation-nodes">
          {philosophies.map((p) => (
            <a href={withBasePath(`/design/philosophy/${p.id.toLowerCase()}`)} class="doc-relation-node doc-relation-node--phil" title={p.title}>
              <span class="doc-relation-node-id">{p.id}</span>
              <span class="doc-relation-node-title">{p.title.length > 30 ? p.title.substring(0, 28) + "…" : p.title}</span>
            </a>
          ))}
        </div>
      </div>

      <!-- Connector -->
      <div class="doc-relation-connector">
        <div class="doc-relation-connector-line"></div>
        <span class="doc-relation-connector-label">drives</span>
        <div class="doc-relation-connector-line"></div>
      </div>

      <!-- Layer 2: Policies -->
      <div class="doc-relation-layer">
        <div class="doc-relation-layer-label">Policies</div>
        <div class="doc-relation-nodes doc-relation-nodes--wrap">
          {policies.map((p) => (
            <a
              href={withBasePath(`/design/policies/${p.id.toLowerCase()}`)}
              class="doc-relation-node doc-relation-node--pol"
              title={`${p.title} → ${p.linkedRequirements.join(", ")}`}
              aria-label={`${p.title} linked requirements: ${p.linkedRequirements.join(", ")}`}
            >
              <span class="doc-relation-node-id">{p.id}</span>
              <span class="doc-relation-node-title">{p.title.length > 24 ? p.title.substring(0, 22) + "…" : p.title}</span>
              <span class="doc-relation-node-badge">{p.linkedRequirements.length} reqs</span>
            </a>
          ))}
        </div>
      </div>

      <!-- Connector -->
      <div class="doc-relation-connector">
        <div class="doc-relation-connector-line"></div>
        <span class="doc-relation-connector-label">translates into</span>
        <div class="doc-relation-connector-line"></div>
      </div>

      <!-- Layer 3: Requirements -->
      <div class="doc-relation-layer">
        <div class="doc-relation-layer-label">Requirements</div>
        <div class="doc-relation-nodes doc-relation-nodes--wrap">
          {reqGroups.map((g) => {
            const linkedPolicies = policies.filter((p) => p.linkedRequirements.includes(g.setId));
            return (
              <a
                href={withBasePath(`/design/requirements#${g.setId.toLowerCase()}`)}
                class="doc-relation-node doc-relation-node--req"
                title={`${g.scope} ← ${linkedPolicies.map((p) => p.id).join(", ")}`}
                aria-label={`${g.setId} linked features: ${(reqToFeatureMap.get(g.setId) ?? []).join(", ") || "none"}`}
              >
                <span class="doc-relation-node-id">{g.setId}</span>
                <span class="doc-relation-node-title">{g.requirements.length} reqs</span>
                <span class="doc-relation-node-badge">{linkedPolicies.length} policies</span>
              </a>
            );
          })}
        </div>
      </div>

      <!-- Connector -->
      <div class="doc-relation-connector">
        <div class="doc-relation-connector-line"></div>
        <span class="doc-relation-connector-label">manifests as</span>
        <div class="doc-relation-connector-line"></div>
      </div>

      <!-- Layer 4: Features -->
      <div class="doc-relation-layer">
        <div class="doc-relation-layer-label">Features</div>
        <div class="doc-relation-nodes">
          {featureGroups.map((g) => (
            <a href={withBasePath(`/design/features#${g.kind.toLowerCase()}`)} class="doc-relation-node doc-relation-node--feat" title={`${g.apis.length} operations`}>
              <span class="doc-relation-node-id">{g.kind}</span>
              <span class="doc-relation-node-title">{g.apis.length} ops</span>
            </a>
          ))}
        </div>
      </div>
    </div>
  </section>

  <!-- Policy connection detail cards -->
  <section id="policy-detail">
    <h2 style="font-size: 1.25rem; font-weight: 700; margin-bottom: 1rem;">Policy Connections</h2>
    <p style="font-size: 0.8125rem; color: var(--doc-muted); margin-bottom: 1.5rem; line-height: 1.6;">
      Each policy connects to requirement categories and specifications. Click the links below to navigate to details.
    </p>
    <div class="doc-grid">
      {policies.map((pol) => (
        <div class="doc-card doc-card-hover" style="position: relative;">
          <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.75rem;">
            <span class="doc-pill">{pol.id}</span>
          </div>
          <h3 style="font-size: 0.9375rem; font-weight: 700; margin-bottom: 0.5rem;">
            <a href={withBasePath(`/design/policies/${pol.id.toLowerCase()}`)} style="color: inherit;">{pol.title}</a>
          </h3>
          <p style="font-size: 0.75rem; color: var(--doc-muted); line-height: 1.6; margin-bottom: 0.75rem;">{pol.summary}</p>

          {pol.linkedRequirements.length > 0 && (
            <div style="margin-bottom: 0.5rem;">
              <div style="font-size: 0.6875rem; font-weight: 600; color: var(--doc-muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.25rem;">Requirements</div>
              <div style="display: flex; flex-wrap: wrap; gap: 0.25rem;">
                {pol.linkedRequirements.map((req) => (
                  <a href={withBasePath(`/design/requirements#${req.toLowerCase()}`)} class="doc-pill doc-pill-outline" style="font-size: 0.625rem; text-decoration: none;">{req}</a>
                ))}
              </div>
            </div>
          )}

          {pol.linkedSpecifications.length > 0 && (
            <div>
              <div style="font-size: 0.6875rem; font-weight: 600; color: var(--doc-muted); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.25rem;">Specifications</div>
              <div style="display: flex; flex-wrap: wrap; gap: 0.25rem;">
                {pol.linkedSpecifications.map((spec) => (
                  <span class="doc-pill doc-pill-outline" style="font-size: 0.625rem;">{spec}</span>
                ))}
              </div>
            </div>
          )}
        </div>
      ))}
    </div>
  </section>
</BaseLayout>
