---
export interface Props {
  method: string;
  endpoint: string;
}

const { method, endpoint } = Astro.props;
const targetId = `target-${method.toLowerCase()}-${endpoint.replaceAll(/[^a-zA-Z0-9]/g, "-")}`;
const commandId = `command-${method.toLowerCase()}-${endpoint.replaceAll(/[^a-zA-Z0-9]/g, "-")}`;
---

<div class="doc-console" data-method={method} data-endpoint={endpoint}>
  <div class="grid gap-2 text-sm md:grid-cols-[1fr_auto] md:items-end">
    <label for={targetId} class="block">
      <span class="text-xs" style="color: var(--doc-muted);">Target domain</span>
      <input id={targetId} type="url" value="http://localhost:8000" class="mt-1 w-full rounded border px-3 py-2" style="border-color: var(--doc-border); background: var(--doc-card);" />
    </label>
    <button type="button" data-copy-target={commandId} class="rounded-full border px-3 py-2 text-sm" style="border-color: var(--doc-border);">Copy curl</button>
  </div>
  <pre id={commandId} class="doc-terminal"><code>{`curl -X ${method.toUpperCase()} http://localhost:8000${endpoint}`}</code></pre>
</div>

<script is:inline>
  const root = document.currentScript?.parentElement;
  if (root) {
    const input = root.querySelector("input");
    const terminal = root.querySelector("pre code");
    const copyButton = root.querySelector("button[data-copy-target]");
    const apiMethod = root.getAttribute("data-method") ?? "GET";
    const apiEndpoint = root.getAttribute("data-endpoint") ?? "/";

    const refresh = () => {
      const domain = input instanceof HTMLInputElement ? input.value.replace(/\/$/, "") : "http://localhost:8000";
      if (terminal) {
        terminal.textContent = "curl -X " + apiMethod.toUpperCase() + " " + domain + apiEndpoint;
      }
    };

    input?.addEventListener("input", refresh);
    refresh();

    copyButton?.addEventListener("click", async () => {
      const content = terminal?.textContent ?? "";
      await navigator.clipboard.writeText(content);
      copyButton.textContent = "Copied";
      setTimeout(() => {
        copyButton.textContent = "Copy curl";
      }, 1000);
    });
  }
</script>
